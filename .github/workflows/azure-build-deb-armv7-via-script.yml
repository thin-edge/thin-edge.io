name: azure-build-deb-armv7-via-script

# Build a debian package for architecture armv7 with exernal script.
# The script is currently necessary to modify the environment prior to
# compilation.

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
     runs-on: self-hosted

     steps:

      - name: checkout
        uses: actions/checkout@v2

      - name: enable toolchain via github action
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: armv7-unknown-linux-gnueabihf
          override: true

      - name: Test and Build script
        # we build within a script as there is no action for cargo deb yet
        run:  bash  ./ci/azure-build-deb-armv7.sh

      - name: upload artifacts as zip
        # https://github.com/marketplace/actions/upload-a-build-artifact
        uses: actions/upload-artifact@v2
        with:
          name: debian-packages-armhf
          path: target/armv7-unknown-linux-gnueabihf/debian/*.deb

      - name: upload tedge
        uses: kittaakos/upload-artifact-as-is@v0
        # https://github.com/marketplace/actions/upload-a-build-artifact-as-is
        with:
          path: 'target/armv7-unknown-linux-gnueabihf/debian/tedge_0.1.0_armhf.deb'

      - name: upload mapper
        uses: kittaakos/upload-artifact-as-is@v0
        # https://github.com/marketplace/actions/upload-a-build-artifact-as-is
        with:
          path: 'target/armv7-unknown-linux-gnueabihf/debian/c8y_mapper_0.1.0_armhf.deb'

