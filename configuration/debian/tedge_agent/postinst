#!/bin/sh

set -e

# Create a group "tedge-agent" if not created before
if ! getent group tedge-agent > /dev/null; then
    addgroup --quiet --system tedge-agent
fi

# Create a user "tedge-agent" if not created before
if ! getent passwd tedge-agent > /dev/null; then
    adduser --quiet --system --no-create-home --ingroup tedge-agent --shell /usr/sbin/nologin tedge-agent
fi

### Create file in /etc/sudoers.d directory
echo "%tedge-agent   ALL = (ALL) /usr/bin/tedge_agent" > /etc/sudoers.d/tedge-agent

if [ -f "/etc/sudoers.d/010_pi-nopasswd" ]; then
    echo "%tedge-agent   ALL = (ALL) NOPASSWD: /usr/bin/tedge_agent" > /etc/sudoers.d/tedge-agent-nopasswd
fi

## Enable the sm services if the device is connected to c8y cloud
if [ -f "/etc/tedge/mosquitto-conf/c8y-bridge.conf" ]; then 
    systemctl start tedge-agent.service
    systemctl start tedge-mapper-sm-c8y.service    
fi
#DEBHELPER#
