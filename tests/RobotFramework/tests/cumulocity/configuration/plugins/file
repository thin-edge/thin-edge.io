#!/bin/sh
set -eu

CONFIG_TYPE="test-conf"
CONFIG_PATH="/etc/tedge/test.conf"

usage() {
    echo "Usage: $0 <command> [args...]"
    echo "Commands:"
    echo "  list                                    List all config types supported by this plugin"
    echo "  get <type>                              Print the config for the specified type to stdout"
    echo "  prepare <type> <workdir>                Backup current config and prepare for update"
    echo "  set <type> <new-config-path>            Update the config for the specified type from the new config path"
    echo "  apply <type>                            Apply the new configuration (restart service)"
    echo "  verify <type>                           Verify the new configuration is working"
    echo "  rollback <type> <workdir>               Restore config from backup"
    echo "  commit <type> <workdir>                 Finalize the update (cleanup backup)"
    exit 1
}

list_config_types() {
    echo $CONFIG_TYPE
}

get_config() {
    cat "$CONFIG_PATH"
}

prepare_config() {
    type="$1"
    workdir="$2"

    # Backup current config
    cp "$CONFIG_PATH" "${workdir}/config.backup"

    # Capture current PID to verify restart later
    systemctl show tedge-agent --property=MainPID --value > "${workdir}/pre_restart_pid.txt"

    echo "Config backed up to ${workdir}/config.backup" >&2
}

set_config() {
    target_config="$2"
    mv "$target_config" "$CONFIG_PATH"

    echo "Config updated" >&2
}

apply_config() {
    type="$1"
    workdir="$2"

    systemctl restart tedge-agent
}

verify_config() {
    type="$1"
    workdir="$2"

    # Check if service is active
    if ! systemctl is-active tedge-agent > /dev/null; then
        echo "Service tedge-agent is not active" >&2
        exit 1
    fi

    # Verify restart by comparing PID
    if [ ! -f "${workdir}/pre_restart_pid.txt" ]; then
        echo "Error: Missing pre-restart PID file" >&2
        exit 1
    fi

    pre_pid=$(cat "${workdir}/pre_restart_pid.txt")
    current_pid=$(systemctl show tedge-agent --property=MainPID --value)

    if [ "$pre_pid" = "$current_pid" ]; then
        echo "Error: Service PID unchanged ($pre_pid), restart may not have occurred" >&2
        exit 1
    fi

    echo "Restart verified: PID changed from $pre_pid to $current_pid" >&2
}

finalize_config() {
    echo "Configuration update finalized successfully"

    # No need to cleanup the backup/metadata files in the workdir,
    # as they are cleaned up automatically by the agent on operation completion.
}

rollback_config() {
    type="$1"
    workdir="$2"

    backup_file="${workdir}/config.backup"

    if [ ! -f "$backup_file" ]; then
        echo "Error: Backup file not found at $backup_file" >&2
        exit 1
    fi

    echo "Rolling back to previous configuration..." >&2

    # Restore backup
    cp "$backup_file" "$CONFIG_PATH"

    # Restart service with old config
    systemctl restart tedge-agent

    # Verify rollback worked
    if systemctl is-active tedge-agent > /dev/null; then
        echo "Rollback successful, service is running" >&2
    else
        echo "Warning: Service is not active after rollback" >&2
    fi
}

main() {
    if [ $# -lt 1 ]; then
        usage
    fi

    command="$1"
    shift

    case "$command" in
        list)
            list_config_types
            ;;
        get)
            if [ $# -lt 1 ]; then
                echo "Error: 'get' command requires a <type> argument" >&2
                exit 1
            fi
            get_config "$@"
            ;;
        prepare)
            if [ $# -lt 2 ]; then
                echo "Error: 'prepare' command requires <type> and <workdir> arguments" >&2
                exit 1
            fi
            prepare_config "$@"
            ;;
        set)
            if [ $# -lt 2 ]; then
                echo "Error: 'set' command requires <type> and <new-config-path> arguments" >&2
                exit 1
            fi
            set_config "$@"
            ;;
        apply)
            if [ $# -lt 2 ]; then
                echo "Error: 'apply' command requires <type> and <workdir> arguments" >&2
                exit 1
            fi
            apply_config "$@"
            ;;
        verify)
            if [ $# -lt 2 ]; then
                echo "Error: 'verify' command requires <type> and <workdir> arguments" >&2
                exit 1
            fi
            verify_config "$@"
            ;;
        finalize)
            if [ $# -lt 2 ]; then
                echo "Error: 'commit' command requires <type> and <workdir> arguments" >&2
                exit 1
            fi
            finalize_config "$@"
            ;;
        rollback)
            if [ $# -lt 2 ]; then
                echo "Error: 'rollback' command requires <type> and <workdir> arguments" >&2
                exit 1
            fi
            rollback_config "$@"
            ;;
        *)
            echo "Error: Unknown command '$command'" >&2
            usage
            ;;
    esac
}

main "$@"
