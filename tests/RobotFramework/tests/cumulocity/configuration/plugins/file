#!/bin/sh
set -eu

CONFIG_TYPE="test-conf"
CONFIG_PATH="/etc/tedge/test.conf"

usage() {
    echo "Usage: $0 <command> [args...]"
    echo "Commands:"
    echo "  list                                    List all config types supported by this plugin"
    echo "  get <type>                              Print the config for the specified type to stdout"
    echo "  set <type> <new-config-path>            Update the config for the specified type from the new config path"
    exit 1
}

list_config_types() {
    echo $CONFIG_TYPE
}

get_config() {
    cat "$CONFIG_PATH"
}

set_config() {
    target_config="$2"
    mv "$target_config" "$CONFIG_PATH"
}

apply_config() {
    systemctl restart tedge-agent
}

verify_config() {
    systemctl is-active tedge-agent
}

main() {
    if [ $# -lt 1 ]; then
        usage
    fi

    command="$1"
    shift

    case "$command" in
        list)
            list_config_types
            ;;
        get)
            if [ $# -lt 1 ]; then
                echo "Error: 'get' command requires a <type> argument" >&2
                exit 1
            fi
            get_config "$@"
            ;;
        set)
            if [ $# -lt 1 ]; then
                echo "Error: 'set' command requires <type> and <new-config-path> arguments" >&2
                exit 1
            fi
            set_config "$@"
            ;;
        apply)
            if [ $# -lt 1 ]; then
                echo "Error: 'apply' command requires a <type> argument" >&2
                exit 1
            fi
            apply_config "$@"
            ;;
        verify)
            if [ $# -lt 1 ]; then
                echo "Error: 'verify' command requires a <type> argument" >&2
                exit 1
            fi
            verify_config "$@"
            ;;
        *)
            echo "Error: Unknown command '$command'" >&2
            usage
            ;;
    esac
}

main "$@"
